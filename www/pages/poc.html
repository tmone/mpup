<template>
    <div class="page">
        <div class="navbar">
            <div class="navbar-inner sliding">
                <div class="left">
                    <a href="#" class="link back">
                        <i class="icon icon-back"></i>
                        <span class="ios-only">Back</span>
                    </a>
                </div>
                <div class="title head-title">CHI TIẾT</div>
                <div class="right save-command" style="display:none;">
                    <a class="link icon-only save" href="#">
                        <i class="icon f7-icons ios-only">save</i>
                        <i class="icon material-icons md-only">save</i>
                    </a>
                </div>
            </div>
        </div>
        <div class="page-content">
            <form id="form0">
                <input type="hidden" name="ID" value="{{poc.ID}}" id="POCID">
                <input type="hidden" name="Pickup_Order_ID" value="{{poc.Pickup_Order_ID}}">
                <input type="hidden" name="Staff_PickUp_Code" value="{{poc.Staff_PickUp_Code}}">
                <div class="swiper-container swiper-init" data-pagination='{"el": ".swiper-pagination"}'
                    data-space-between="100" data-threshold="50">
                    <div class="swiper-pagination" style="top: 5px;bottom : auto;"></div>
                    <div class="swiper-wrapper">
                        <div class="swiper-slide">
                            <div class="list">

                                <ul>
                                    <li>
                                        <div class="item-content item-input">
                                            <div class="item-inner">
                                                <div class="item-title item-label">Người nhận</div>
                                                <div class="item-input-wrap">
                                                    <input type="text" name="Recipient_Name"
                                                        placeholder="Tên khách hàng" id="Recipient_Name"
                                                        value="{{poc.Recipient_Name}}">

                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    {{#each poc.PHONES}}
                                    <li {{#if Show}}style='display:block;' {{else}}style='display:none;' {{/if}}
                                        data-index="{{Index}}">
                                        <div class="item-content item-input">
                                            <div class="item-inner">
                                                <div class="item-title item-label">Điện thoại</div>
                                                <div class="item-input-wrap">
                                                    <input type="numpad" name="{{Phone_Name}}" placeholder="Điện thoại"
                                                        id="mobile{{Index}}" value="{{Phone_Value}}"
                                                        data-dot-character=";" data-dot-button="true">
                                                </div>
                                            </div>
                                            <div class="item_after" style="padding-right:15px; display:block"
                                                data-phone="{{Phone_Name}}">
                                                <a class="link icon-only add-num" href="#" data-index="{{Index}}">
                                                    <i class="icon f7-icons ios-only">add</i>
                                                    <i class="icon material-icons md-only">add</i>
                                                </a>
                                            </div>
                                        </div>
                                    </li>
                                    {{/each}}
                                    <li>
                                        <div class="item-content item-input">
                                            <div class="item-inner">
                                                <div class="item-title item-label">Số nhà</div>
                                                <div class="item-input-wrap">
                                                    <input type="text" name="Recipient_Soi" placeholder="Số nhà"
                                                        value="{{poc.Recipient_Soi}}" id="Recipient_Soi">
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="item-content item-input">
                                            <div class="item-inner">
                                                <div class="item-title item-label">Đường, phố</div>
                                                <div class="item-input-wrap">
                                                    <input type="text" name="Recipient_Road" placeholder="Đường, phố"
                                                        value="{{poc.Recipient_Road}}">
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <a class="item-link smart-select smart-select-init select-province "
                                            data-searchbar="true" data-searchbar-placeholder="Nhập tên tỉnh, thành phố"
                                            data-close-on-select="true">
                                            <select name="Recipient_Province_ID" id="Recipient_Province_ID">
                                                {{#each Provinces}}
                                                <option value="{{ID}}" {{#if Selected}}selected{{/if_js}}>
                                                    [{{Province_Code}}]
                                                    {{Province_TH_Desc}}</option>
                                                {{/each}}
                                            </select>
                                            <div class="item-content">
                                                <div class="item-inner">
                                                    <div class="item-title">Tỉnh, thành phố</div>
                                                </div>
                                            </div>
                                        </a>
                                    </li>
                                    <li>
                                        <a class="item-link smart-select smart-select-init select-district "
                                            data-searchbar="true" data-searchbar-placeholder="Nhập tên quận, huyện"
                                            data-close-on-select="true">
                                            <select name="Recipient_District_ID" id="Recipient_District_ID">
                                                {{#each Districts}}
                                                <option value="{{ID}}" {{#if Selected}}selected{{/if_js}}>
                                                    [{{District_Code}}]
                                                    {{District_TH_Desc}}</option>
                                                {{/each}}
                                            </select>
                                            <div class="item-content">
                                                <div class="item-inner">
                                                    <div class="item-title">Quận, huyện</div>
                                                    <div class="item-after" id="Recipient_District_Name"></div>
                                                </div>
                                            </div>
                                        </a>
                                    </li>
                                    <li>
                                        <a class="item-link smart-select smart-select-init select-subdistrict "
                                            data-searchbar="true" data-searchbar-placeholder="Nhập tên xã phường"
                                            data-close-on-select="true">
                                            <select name="Recipient_SubDistrict_ID" id="Recipient_SubDistrict_ID">
                                                {{#each SubDistricts}}
                                                <option value="{{ID}}" {{#if Selected}}selected{{/if_js}}>
                                                    [{{SubDistrict_Code}}]
                                                    {{SubDistrict_TH_Desc}}</option>
                                                {{/each}}
                                            </select>
                                            <div class="item-content">
                                                <div class="item-inner">
                                                    <div class="item-title">Xã, phường</div>
                                                    <div class="item-after" id="Recipient_SubDistrict_Name"></div>
                                                </div>
                                            </div>
                                        </a>
                                    </li>
                                    <li>
                                        <div class="item-content item-input">
                                            <div class="item-inner">
                                                <div class="item-title item-label">Địa chỉ</div>
                                                <div class="item-text">
                                                    <input type="text" readonly name="Recipient_Address"
                                                        placeholder="Địa chỉ" value="{{poc.Recipient_Address}}"
                                                        id="Recipient_Address">
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="swiper-slide">
                            <div class="list">
                                <ul>
                                    <li>
                                        <div class="item-content item-input">
                                            <div class="item-inner">
                                                <div class="item-title item-label">Số kiện</div>
                                                <div class="item-input-wrap">
                                                    <!-- <input type="numpad" name="Total_Package" placeholder="Số kiện"
                                                        id="Total_Package" value="{{poc.Total_Package}}"
                                                        data-dot-button="false"> -->
                                                    <div id="Total_Package"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="item-content item-input">
                                            <div class="item-inner">
                                                <div class="item-title item-label">Số DOC</div>
                                                <div class="item-input-wrap">
                                                    <!-- <input type="numpad" name="Package_Doc" placeholder="Số DOC"
                                                        id="Package_Doc" value="{{poc.Package_Doc}}"
                                                        data-dot-button="false" readonly> -->
                                                    <div id="Package_Doc"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    <!-- <li>
                                        <div class="item-content">
                                            <div class="item-inner">
                                                <div class="item-title">DOC</div>
                                                <div class="item-after">
                                                    <label class="toggle toggle-init">
                                                        <input type="checkbox" name="Cargo_Type" value="yes"><i
                                                            class="toggle-icon"></i>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </li> -->
                                    <li>
                                        <div class="item-content item-input">
                                            <div class="item-inner">
                                                <div class="item-title item-label">Khối lượng</div>
                                                <div class="item-input-wrap">
                                                    <!-- <input type="number" name="Actual_Weight" placeholder="Khối lượng"
                                                        id="Actual_Weight" value="{{poc.Actual_Weight}}"> -->
                                                    <div id="Actual_Weight"></div>
                                                </div>
                                            </div>
                                            <!-- <div class="item_after" style="padding-right:15px;">
                                                <a class="link icon-only add-weight popup-open"
                                                    data-popup=".popup-weight" href="#" data-grid="weight">
                                                    <i class="icon f7-icons ios-only">add</i>
                                                    <i class="icon material-icons md-only">add</i>
                                                </a>
                                            </div> -->
                                        </div>
                                    </li>
                                    <li>
                                        <div class="item-content item-input">
                                            <div class="item-inner">
                                                <div class="item-title item-label">Khối lượng qui đổi</div>
                                                <div class="item-input-wrap">
                                                    <!-- <input type="number" name="Dim_Weight" placeholder="K.lượng qui đổi"
                                                        id="Dim_Weight" value="{{poc.Dim_Weight}}"> -->
                                                    <div id="Dim_Weight"></div>
                                                </div>
                                            </div>
                                            <div class="item_after" style="padding-right:15px;">
                                                <a class="button button-outline add-dim-weight popup-open"
                                                    data-popup=".popup-weight" href="#" data-grid="dim">
                                                    <!-- <i class="icon f7-icons ios-only">add</i>
                                                    <i class="icon material-icons md-only">add</i> -->
                                                    DxRxC
                                                </a>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <a class="item-link smart-select smart-select-init select-services "
                                            data-searchbar="true" data-searchbar-placeholder="Dịch vụ"
                                            data-close-on-select="true">
                                            <select name="Service_ID" id="Service_ID">
                                                {{#each Services}}
                                                <option value="{{ID}}" {{#if Selected}}selected{{/if_js}}>
                                                    [{{Service_Code}}]
                                                    {{Service_TH_Name}}</option>
                                                {{/each}}
                                            </select>
                                            <div class="item-content">
                                                <div class="item-inner">
                                                    <div class="item-title">Dịch vụ</div>
                                                </div>
                                            </div>
                                        </a>
                                    </li>
                                    <li>
                                        <div class="item-content item-input">
                                            <div class="item-inner">
                                                <div class="item-title item-label">Giá trị hàng hóa</div>
                                                <div class="item-input-wrap">
                                                    <!-- <input type="calculator" name="Declared_Value"
                                                        placeholder="Giá trị hàng hóa" id="Declared_Value"
                                                        value="{{poc.Declared_Value}}" class="format-number"> -->
                                                    <div id="Declared_Value"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="item-content item-input">
                                            <div class="item-inner">
                                                <div class="item-title item-label">Tiền thu hộ</div>
                                                <div class="item-input-wrap">
                                                    <!-- <input type="calculator" name="COD_Amount" placeholder="Tiền thu hộ"
                                                        id="COD_Amount" value="{{poc.COD_Amount}}"> -->
                                                    <div id="COD_Amount"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    <!-- <li>
                                        <div class="item-content">
                                            <div class="item-inner">
                                                <div class="item-title">Đóng gỗ</div>
                                            </div>
                                            <div class="item_after" style="padding-right:15px;">
                                                <a class="link icon-only add-wood popup-open" data-popup=".popup-weight"
                                                    href="#" data-grid="weight">
                                                    <i class="icon f7-icons ios-only">drawers_fill</i>
                                                    <i class="icon material-icons md-only">all_inbox</i>
                                                </a>
                                            </div>
                                        </div>
                                    </li> -->
                                    <li>
                                        <a class="item-link smart-select smart-select-init select-payment"
                                            data-open-in="popup" data-searchbar-placeholder="Hình thức TT"
                                            data-close-on-select="true">
                                            <select name="Payment_Type" id="Payment_Type">
                                                <option value="NG" selected>Đã thanh toán</option>
                                                <option value="NN">Người nhận</option>
                                                <option value="GS">Thanh toán sau</option>
                                            </select>
                                            <div class="item-content">
                                                <div class="item-inner">
                                                    <div class="item-title">Hình thức TT</div>
                                                </div>
                                            </div>
                                        </a>
                                    </li>
                                    <li style="display:none;" class="customer-code">
                                        <div class="item-content item-input">
                                            <div class="item-inner">
                                                <div class="item-title item-label">Mã Khách hàng</div>
                                                <div class="item-input-wrap">
                                                    <input type="text" name="Customer_Code" placeholder="Mã khách hàng"
                                                        value="{{poc.Customer_Code}}">
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="swiper-slide">
                            <div class="list">
                                <ul>
                                    <li>
                                        <div class="item-content item-input">
                                            <div class="item-inner">
                                                <div class="item-title item-label">Nội dung hàng hóa</div>
                                                <div class="item-input-wrap">
                                                    <textarea id="Consignment_Package_Remark"
                                                        name="Consignment_Package_Remark"
                                                        value="{{poc.Consignment_Package_Remark}}"
                                                        placeholder="Nội dung hàng hóa"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="item-content item-input">
                                            <div class="item-inner">
                                                <div class="item-title item-label">Số tham chiếu</div>
                                                <div class="item-input-wrap">
                                                    <input type="text" name="Consignment_Ref_Number"
                                                        value="{{poc.Consignment_Ref_Number}}"
                                                        placeholder="Số tham chiếu" id="Consignment_Ref_Number">
                                                </div>
                                            </div>
                                            <div class="item_after" style="padding-right:15px;">
                                                <a class="link icon-only scan-barcode" href="#">
                                                    <i class="icon f7-icons ios-only">qrcode</i>
                                                    <i class="icon material-icons md-only">aspect_ratio</i>
                                                </a>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <div class="card">
                                <div class="card-content card-content-padding">
                                    <p>Lưu ý các trường hợp sử dụng số tham chiếu:</p>
                                    <p>1. Người gửi sử dụng số liên lạc không thể nhận thông tin bằng tin nhắn.</p>
                                    <p>2. Khách hàng yêu cầu, bắt buộc phải cung cấp vận đơn để xác nhận trạng thái đơn
                                        hàng.</p>
                                </div>
                            </div>
                        </div>
                        <div class="swiper-slide">
                            <div class="list">
                                <ul>
                                    <li>
                                        <div class="item-content item-input">
                                            <div class="item-inner">
                                                <div class="item-title item-label">Số vận đơn</div>
                                                <div class="item-input-wrap">
                                                    <input type="text" readonly name="Consignment_No"
                                                        value="{{poc.Consignment_No}}" placeholder="Số vận đơn"
                                                        id="Consignment_No">
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <div class="insert">
                                <div id="grid-summary"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <input type="hidden" id="Freight_Charge" name="Freight_Charge" value="{{poc.Freight_Charge}}">
                <input type="hidden" id="Total_Charge" name="Total_Charge" value="{{poc.Total_Charge}}">
                <input type="hidden" id="Charge_Weight" name="Charge_Weight" value="{{poc.Charge_Weight}}">
            </form>
        </div>
        <div class="popup popup-weight">
            <div id="grid-weight">

            </div>
        </div>
    </div>
</template>
<style>
    p {
        margin: 10px 0;
    }

    .hidden {
        display: none;
    }

    .showden {
        display: auto;
    }

    .right-number .dx-numberbox input[type=text] {
        text-align: right;
    }

    .right-number .inline-labels .item-label {
        width: 60%;
    }

    .dx-dropdowneditor-overlay-flipped {
        width: 200px;
    }
</style>
<script type="text/javascript">
    var cln = "";
    var TYPEGRID = "weight";
    var SHORT = false;
    function formItem() {
        if (TYPEGRID == "weight")
            return [
                { dataField: "Package_Weight", colSpan: 2 },
                "Dong_Go",
                "Package_Length",
                "Package_Width",
                "Package_Height"
            ];
        return [
            "Package_Length",
            "Package_Width",
            "Package_Height"
        ];
    }
    try {
        cln = device.serial + ' ' + device.model + ' ' + device.manufacturer;
    } catch (e) { }
    return {
        // Component Data
        data: function () {
            // Must return an object
            return {
                poc: {},
                swiper: null,
                Store: {},
                store: null,
                summaryStore: null,
                pocID: null,
            }
        },
        // Component Methods
        methods: {
            updateAddress: function () {
                //debugger;
                var formData = app.form.convertToData("#form0") || {};
                var str = "";
                if (formData.Recipient_Soi && formData.Recipient_Soi.length > 0) {
                    if (str.length > 0) {
                        str += ", ";
                    }
                    str += formData.Recipient_Soi;
                }
                if (formData.Recipient_Road && formData.Recipient_Road.length > 0) {
                    if (str.length > 0) {
                        str += ", ";
                    }
                    str += formData.Recipient_Road;
                }
                if (formData.Recipient_SubDistrict_ID && formData.Recipient_SubDistrict_ID > 0) {
                    var f = SUBDISTRICTS.find(function (x) {
                        return x.ID == formData.Recipient_SubDistrict_ID;
                    }) || {};
                    if (f && f.SubDistrict_TH_Desc && f.SubDistrict_TH_Desc.length > 0) {
                        if (str.length > 0) str += ", ";
                        str += f.SubDistrict_TH_Desc;
                    }
                }
                if (formData.Recipient_District_ID && formData.Recipient_District_ID > 0) {
                    var f = DISTRICTS.find(function (x) {
                        return x.ID == formData.Recipient_District_ID;
                    }) || {};
                    if (f && f.District_TH_Desc && f.District_TH_Desc.length > 0) {
                        if (str.length > 0) str += ", ";
                        str += f.District_TH_Desc;
                    }
                }
                if (formData.Recipient_Province_ID && formData.Recipient_Province_ID > 0) {
                    var f = PROVINCES.find(function (x) {
                        return x.ID == formData.Recipient_Province_ID;
                    }) || {};
                    if (f && f.Province_TH_Desc && f.Province_TH_Desc.length > 0) {
                        if (str.length > 0) str += ", ";
                        str += f.Province_TH_Desc;
                    }
                }

                $$("#Recipient_Address").val(str);
            },
            refreshDistrict: function (Province_ID) {
                $$("#Recipient_District_ID").empty();
                DISTRICTS.filter(function (x) {
                    return x.Province_ID == Province_ID || x.Province_ID == 1;
                }).map(function (x) {
                    $$("#Recipient_District_ID").append('<option value="' + x.ID + '">' + x.District_TH_Desc + '</option>');
                });
            },
            refreshSubDistrict: function (District_ID) {
                $$("#Recipient_SubDistrict_ID").empty();
                SUBDISTRICTS.filter(function (x) {
                    return x.District_ID == District_ID || x.District_ID == 3760;
                }).map(function (x) {
                    $$("#Recipient_SubDistrict_ID").append('<option value="' + x.ID + '">' + x.SubDistrict_TH_Desc + '</option>');
                });
            },
            init_Consignment_No: function () {
                var d = new Date();
                var str = "CAL";
                // var y = d.getFullYear() % 100;
                // str += (y < 10 ? "0" : "") + y;
                // str += d.getMonth().toString(16).toUpperCase();
                // var da = d.getDate();
                // str += (da < 10 ? "0" : "") + da;
                // var h = d.getHours();
                // str += (h < 10 ? "0" : "") + h;
                // var m = d.getMinutes();
                // str += (m < 10 ? "0" : "") + m;
                // var s = d.getSeconds();
                // str += (s < 10 ? "0" : "") + s;
                str += d.getTime().toString(36).toUpperCase();
                str += app.data.user.user_name.replace(/[^0-9A-Za-z]/g, "");

                return str.substr(0, 20);
            },
            refresh: function () {
                var self = this;
                var pocID = self.poc.Pickup_Order_ID;
                mainView.router.navigate("/po/" + pocID + "/");
            },
            save: function () {
                var self = this;
                var data = app.form.convertToData("#form0");

                data = Object.assign(self.poc, data);

                if (!data.Recipient_Name || data.Recipient_Name.length <= 0) {
                    app.toast.create({
                        text: "Chưa nhập thông tin: Người nhận",
                        closeTimeout: 2000,
                    }).open();
                    self.swiper.slideTo(0);
                    $$("#Recipient_Name").focus();
                    return;
                }
                //$$(".Recipient_Name").text(data.Recipient_Name);
                var phones = [];
                $.each($("[id^=mobile]"), function (x) {
                    phones.push($(this).val());
                });
                data.Recipient_Mobile = phones.filter(function (x) {
                    var t = +(x || "").replace(/[^0-9]/g, '');
                    return x && x.length >= 10 && t > 99999999;
                }).join(";");
                //data.Phone_No+";"+data.Mobile_No1+";"+data.Mobile_No2;
                if (data.Recipient_Mobile.length < 10 || data.Recipient_Mobile.includes("undefined")) {
                    app.toast.create({
                        text: "Điện thoại không đúng",
                        closeTimeout: 2000,
                    }).open();
                    //$$("#Phone_No").focus();
                    self.swiper.slideTo(0);
                    return;
                }
                //$$(".Phone_No").text(data.Phone_No);
                //$$(".Contact_Person").text(data.Contact_Person);
                if (!data.Recipient_Province_ID || data.Recipient_Province_ID <= 1) {
                    app.toast.create({
                        text: "Chưa nhập thông tin: Tỉnh, thành phố",
                        closeTimeout: 2000,
                    }).open();
                    self.swiper.slideTo(0);
                    return;
                }
                if (!data.Recipient_District_ID || +data.Recipient_District_ID == 3760 || +data.Recipient_District_ID == 3761) {
                    app.toast.create({
                        text: "Chưa nhập thông tin: Quận, huyện",
                        closeTimeout: 2000,
                    }).open();
                    self.swiper.slideTo(0);
                    return;
                }
                //debugger;
                if (!data.Recipient_Address || data.Recipient_Address < 10) {
                    app.toast.create({
                        text: "Lỗi. Địa chỉ quá ngắn",
                        closeTimeout: 2000,
                    }).open();
                    self.swiper.slideTo(0);
                    $$("#Recipient_Address").focus();
                    return;
                }
                var sk = 0;
                if (data.Total_Package && data.Total_Package > 0) {
                    sk += data.Total_Package;
                }
                if (data.Package_Doc && data.Package_Doc > 0) {
                    sk += data.Package_Doc;
                }
                if (sk <= 0) {
                    app.toast.create({
                        text: "Chưa nhập số kiện hoặc số DOC",
                        closeTimeout: 2000,
                    }).open();
                    self.swiper.slideTo(1);
                    $("#Total_Package").dxNumberBox("instance").focus();
                    return;
                }
                var total_weight = 0;
                if (data.Actual_Weight && +data.Actual_Weight > 0) {
                    if (total_weight < +data.Actual_Weight) {
                        total_weight = +data.Actual_Weight;
                    }
                }
                if (data.Dim_Weight && +data.Dim_Weight > 0) {
                    if (total_weight < +data.Dim_Weight) {
                        total_weight = +data.Dim_Weight;
                    }
                }
                if (total_weight <= 0) {
                    app.toast.create({
                        text: "Khối lượng không đúng",
                        closeTimeout: 2000,
                    }).open();
                    self.swiper.slideTo(1);
                    $("#Actual_Weight").dxNumberBox("instance").focus();
                    return;
                }
                data.Charge_Weight = total_weight;

                if (!data.Service_ID || +data.Service_ID < 1) {
                    app.toast.create({
                        text: "Loại dịch vụ chưa áp dụng",
                        closeTimeout: 2000,
                    }).open();
                    self.swiper.slideTo(1);
                    //$$("#Service_ID").focus();
                    return;
                }
                if (data.Payment_Type && data.Payment_Type == "GS" && (!data.Customer_Code || data.Customer_Code.length < 7)) {
                    app.toast.create({
                        text: "Chưa nhập mã khách hàng",
                        closeTimeout: 2000,
                    }).open();
                    self.swiper.slideTo(1);
                    $$("#Customer_Code").focus();
                    return;
                }
                if (!data.Consignment_Package_Remark || +data.Consignment_Package_Remark.length < 3) {
                    app.toast.create({
                        text: "Thông tin hàng hóa quá ngắn!",
                        closeTimeout: 2000,
                    }).open();
                    self.swiper.slideTo(2);
                    //$$("#Consignment_Package_Remark").focus();
                    return;
                }

                if (self.swiper.activeIndex != 3) {
                    // app.toast.create({
                    //     text: "Tổng tiền cước 0 đồng",
                    //     closeTimeout: 2000,
                    // }).open();
                    self.swiper.slideTo(3);
                    return;
                }

                if (!data.Total_Charge || data.Total_Charge <= 0) {
                    var rs = confirm("Tổng tiền cước 0 đồng. Vẫn muốn lưu?");
                    if (rs) {

                    } else {
                        self.swiper.slideTo(1);
                        return;
                    }
                }




                if (!data.Declared_Value) {
                    data.Declared_Value = 0;
                }
                if (!data.COD_Amount) {
                    data.COD_Amount = 0;
                }
                if (!data.Total_Package) {
                    data.Total_Package = 0;
                }
                if (!data.Package_Doc) {
                    data.Package_Doc = 0;
                }
                if (!data.Actual_Weight) {
                    data.Actual_Weight = 0;
                }
                if (!data.Dim_Weight) {
                    data.Dim_Weight = 0;
                }
                if (!data.Charge_Weight) {
                    data.Charge_Weight = 0;
                }
                if (!data.Freight_Charge) {
                    data.Freight_Charge = 0;
                }
                if (!data.ESA_Surcharge) {
                    data.ESA_Surcharge = 0;
                }
                if (!data.VAS_Surcharge) {
                    data.VAS_Surcharge = 0;
                }
                if (!data.Total_Charge) {
                    data.Total_Charge = 0;
                }
                if (!data.Insurance_Surcharge) {
                    data.Insurance_Surcharge = 0;
                }
                if (!data.Other_Surcharge) {
                    data.Other_Surcharge = 0;
                }
                if (!data.Recipient_Postcode || data.Recipient_Postcode.length == 0) {
                    data.Recipient_Postcode = 'N/A';
                }
                if (!data.Pickup_Order_ID || data.Pickup_Order_ID <= 0) {
                    data.Pickup_Order_ID = app.data.lastChoice.ID;
                }

                if (!data.Staff_PickUp_Code || data.Staff_PickUp_Code.length < 1) {
                    data.Staff_PickUp_Code = app.data.user.user_name;
                }


                if (self.Store.insert) {

                } else {
                    self.Store = self.$route.context.Store;
                }

                if (!data.ID || data.ID < 1) {
                    self.Store.insert(data).done(function (dataObj, key) {
                        // Process the key and data object here
                        pocID = dataObj.ID;
                        self.pocID = pocID;
                        self.poc = Object.assign(self.poc, dataObj);
                        $$("#POCID").val(pocID);

                        self.store._array.map(function (x) {
                            x.Pickup_Order_Consignment_ID = pocID;
                        });
                        self.summaryStore._array.map(function (x) {
                            x.Pickup_Order_Consignment_ID = pocID;
                        });
                        self.store.syncServer(function () {
                            self.summaryStore.syncServer(function () {
                                app.data.editing = false;
                                self.refresh();
                            }, function (er) {
                                app.toast.create({
                                    text: "Lỗi: " + er,
                                    closeTimeout: 2000,
                                }).open();
                            });
                        }, function (er) {
                            app.toast.create({
                                text: "Lỗi: " + er,
                                closeTimeout: 2000,
                            }).open();
                        });

                    }).fail(function (error) {
                        // Handle the "error" here
                        app.toast.create({
                            text: "Lỗi: " + JSON.stringify(error),
                            closeTimeout: 2000,
                        }).open();
                    });
                } else {
                    self.Store.update(data.ID, data).done(function (dataObj, key) {
                        // Process the key and data object here                        
                        self.store.syncServer(function () {
                            self.summaryStore.syncServer(function () {
                                app.data.editing = false;
                                self.refresh();
                            }, function (er) {
                                app.toast.create({
                                    text: "Lỗi: " + er,
                                    closeTimeout: 2000,
                                }).open();
                            });
                        }, function (er) {
                            app.toast.create({
                                text: "Lỗi: " + er,
                                closeTimeout: 2000,
                            }).open();
                        })
                    }).fail(function (error) {
                        // Handle the "error" here
                        app.toast.create({
                            text: "Lỗi: " + JSON.stringify(error),
                            closeTimeout: 2000,
                        }).open();
                    });
                }



                //mainView.router.back();
                //debugger;
            },

        },
        // Lifecycle Hooks
        beforeCreate: function () {
            console.log('componentBeforeCreate', this)
        },
        created: function () {
            console.log('componentCreated', this)
        },
        beforeMount: function () {
            console.log('componentBeforeMount', this)
        },
        mounted: function () {
            console.log('componentMounted', this);
        },
        updated: function () {
            console.log('componentUpdated', this);
        },
        beforeDestroy: function () {
            console.log('componentBeforeDestroy', this);
        },
        destroyed: function () {
            console.log('componentDestroyed', this);
        },
        // Page Events
        on: {
            pageMounted: function (e, page) {
                console.log('pageMounted', page);
                //debugger;

            },
            pageInit: function (e, page) {
                console.log('pageInit', page);

                var self = this;
                var pocID = page.route.params.pocID;
                self.pocID = pocID;

                var store = app.methods.initCacher("Pickup_Order_Consignment_Package", [
                    "Pickup_Order_Consignment_ID", "=", pocID
                ]);
                self.store = store;
                var summaryStore = app.methods.initCacher("Pickup_Order_Consignment_Surcharge", [
                    "Pickup_Order_Consignment_ID", "=", pocID
                ]);
                self.summaryStore = summaryStore;

                var replaceCost = function (Charge_Type, Amount) {
                    var fFC = summaryStore.store._array.find(function (x) {
                        return x.Surcharge_Code == Charge_Type;
                    });
                    
                    if (fFC != null) {
                        fFC.Surcharge_Amount_Collect = Amount;
                        fFC.Surcharge_Amount = Amount;
                        summaryStore.store.push([{
                            type: "update",
                            key: fFC.ID,
                            data: fFC
                        }]);
                    } else {
                        summaryStore.store.push([{
                            type: "insert",
                            data: {
                                Pickup_Order_Consignment_ID: pocID,
                                Surcharge_Code: Charge_Type,
                                Surcharge_Amount_Collect: Amount,
                                Surcharge_Amount: Amount,
                                Pickup_Order_Consignment_ID: pocID,
                                Created_By: app.data.user.user_name,
                                Created_Date: new Date(),
                                Last_Source: "Mobile Pickup",
                                Last_Client_Name: cln,                               
                            }
                        }]);
                    }
                }

                var caculationCost = function (finalWeight) {
                    var Service_ID = $$("#Service_ID").val();
                    var Service_Code = getOracleServiceCode(Service_ID);

                    var Custom_Code = app.data.lastChoice.Branch_Code;
                    if (!Custom_Code || Custom_Code.length < 3) {
                        Custom_Code = app.data.lastChoice.Customer_Code;
                    }
                    var Sender_Province_ID = app.data.lastChoice.Province_ID;
                    var Sender_Province = PROVINCES.find(function (x) {
                        return x.ID == Sender_Province_ID;
                    });
                    var Sender_Province_code = Sender_Province.Province_Code || '00';
                    var Receiver_Province_ID = $$("#Recipient_Province_ID").val();
                    var Receiver_Province = PROVINCES.find(function (x) {
                        return x.ID == Receiver_Province_ID;
                    });
                    var Receiver_Province_Code = Receiver_Province.Province_Code || '00';
                    var Receiver_District_ID = $$("#Recipient_District_ID").val();
                    var Receiver_District = DISTRICTS.find(function (x) {
                        return x.ID == Receiver_District_ID;
                    });
                    var Receiver_District_Code = Receiver_District.District_Code || '0000';

                    app.methods.getCost(
                        Custom_Code,
                        Service_Code,
                        finalWeight,
                        Sender_Province_code,
                        Receiver_Province_Code,
                        Receiver_District_Code,
                        function (rs) {
                            if (rs) {
                                replaceCost("FC", rs.Cost);
                                replaceCost("100", rs.FarCharge);
                                replaceCost("110", 0);

                                //$("#Freight_Charge").dxNumberBox("instance").option("value", rs.Cost);
                                //$("#Total_Charge").dxNumberBox("instance").option("value", rs.Cost + rs.FarCharge);
                                $$("#Freight_Charge").val(rs.Cost);
                                $$("#Total_Charge").val(rs.Cost + rs.FarCharge);
                                setTimeout(function () {
                                    $("#grid-summary").dxDataGrid("instance").refresh();
                                }, 100);

                            }

                            // $$("#Freight_Charge").val(rs.Cost);
                            // $$("#ESA_Surcharge").val(rs.FarCharge);
                            // $$("#Total_Charge").val(rs.Cost+rs.FarCharge);

                        });
                }

                store.store.on("modified", function () {
                    var sumWeight = 0;
                    var sumLength = 0;
                    var sumWidth = 0;
                    var sumHeight = 0;
                    var sumCount = 0;
                    var hasDongGo = false;
                    for (var i = 0; i < store.store._array.length; i++) {
                        try {
                            var tmp = store.store._array[i];
                            
                            sumLength += +tmp.Package_Length || 0;
                            sumWidth += +tmp.Package_Width || 0;
                            sumHeight += +tmp.Package_Height || 0;
                            sumCount += 1;
                            hasDongGo = tmp.Charge_Type.includes("wood") || hasDongGo;
                        } catch (ex) { }
                    }
                    //debugger;
                    var iWeight = $("#Actual_Weight").dxNumberBox("instance");
                    var Service_ID = $$("#Service_ID").val();
                    var Service_Code = getOracleServiceCode(Service_ID);
                    var sumDim = app.methods.getDimWeight(sumLength, sumWidth, sumHeight, Service_Code);
                    sumWeight = iWeight.option("value");
                    var finalWeight = Math.max(0, sumDim, sumWeight);

                    $("#Dim_Weight").dxNumberBox("instance").option("value", sumDim);
                    $("#Total_Package").dxNumberBox("instance").option("value", sumCount);
                    $$("#Charge_Weight").val(finalWeight);


                    caculationCost(finalWeight, hasDongGo);
                });

                summaryStore.store.on("modified", function () {
                    var Total_Charge = 0;
                    for (var i = 0; i < summaryStore.store._array.length; i++) {
                        try {
                            var tmp = summaryStore.store._array[i];
                            Total_Charge += tmp.Surcharge_Amount_Collect || 0;
                        } catch (ex) { }
                    }
                    $$("#Total_Charge").val(Total_Charge);
                });

                
                $$(".Recipient_Name").text(self.poc.Recipient_Name || "");                
                $$(".Recipient_Address").text(self.poc.Recipient_Address || "");
                

                $$(".add-num").on("click", function () {
                    var id = $$(this).data("index");
                    var val = $$("#mobile" + id).val();
                    // debugdebugger;
                    if (val && val.length >= 10) {
                        $$(this).parent().hide();
                        id = +id + 1;
                        if (id <= 9) {
                            $$('li[data-index="' + id + '"]').show();
                        }
                    } else {
                        app.toast.create({
                            text: "Hãy nhập đầy đủ số điện thoại!",
                            closeTimeout: 2000,
                        }).open();
                    }

                });
                $$("#Recipient_Province_ID").on("change", function () {
                    var val = $$(this).val();
                    self.refreshDistrict(val);
                    self.refreshSubDistrict();
                    $$("#Recipient_District_ID").val(null);
                    $$("#Recipient_District_Name").text("Chọn quận, huyện");
                    $$("#Recipient_SubDistrict_ID").val(null);
                    $$("#Recipient_SubDistrict_Name").text("Chọn Xã, phường");
                    self.updateAddress();
                });
                $$("#Recipient_District_ID").on("change", function () {
                    var val = $$(this).val();
                    self.refreshSubDistrict(val);
                    $$("#Recipient_SubDistrict_ID").val(null);
                    $$("#Recipient_SubDistrict_Name").text("Chọn Xã, phường");
                    self.updateAddress();
                });
                $$("#Recipient_SubDistrict_ID").on("change", function () {
                    self.updateAddress();
                });
                $$(".save").on("click", function () {
                    self.save();
                });
                

                $$("#Payment_Type").on("change", function () {
                    var vl = $$(this).val();
                    if (vl == "GS") {
                        $$(".customer-code").show();
                    } else {
                        $$(".customer-code").hide();
                    }
                });
                //$$(".add-wood").on("click", function () {}
                $$(".add-wood").on("click", function () {
                    var grid = $("#grid-weight").dxDataGrid("instance");
                    //$$(".popup-open").click();
                    TYPEGRID = "wood";
                    var fi = formItem();
                    grid.option("filterValue", ["Charge_Type", "=", "wood"]);
                    grid.option("editing.form.items", fi);                    
                });
                $$(".add-weight").on("click", function () {
                    var grid = $("#grid-weight").dxDataGrid("instance");
                    //$$(".popup-open").click();
                    TYPEGRID = "weight";
                    var fi = formItem();
                    grid.option("filterValue", ["Charge_Type", "=", "weight"]);
                    grid.option("editing.form.items", fi);
                    // setTimeout(function () {
                    //     grid.addRow();
                    // }, 500);

                });
                $$(".add-dim-weight").on("click", function () {
                    var grid = $("#grid-weight").dxDataGrid("instance");
                    //$$(".popup-open").click();
                    TYPEGRID = "dim";
                    var fi = formItem();
                    grid.option("filterValue", ["Charge_Type", "=", "dim"]);
                    grid.option("editing.form.items", fi);
                    // setTimeout(function () {
                    //     grid.addRow();
                    // }, 500);

                });

                $("#Total_Package").dxNumberBox({
                    format: "###,##0",
                    name: "Total_Package",
                    value: self.poc.Total_Package,
                });
                $("#Package_Doc").dxNumberBox({
                    format: "###,##0",
                    name: "Package_Doc",
                    value: self.poc.Package_Doc,
                });
                $("#Actual_Weight").dxNumberBox({
                    format: "###,##0.000",
                    min: 0.01,
                    name: "Actual_Weight",
                    value: self.poc.Actual_Weight,
                    onValueChanged: function (e) {
                        caculationCost(e.value);
                    },                    
                });

                $("#Dim_Weight").dxNumberBox({
                    format: "###,##0.000",
                    name: "Dim_Weight",//COD_Amount
                    min: 0.01,
                    value: self.poc.Dim_Weight,
                    readOnly: true,
                    onFocusIn: function (e) {
                        var firstdim = store.store._array.filter(function (x) {
                            return x.Charge_Type == "dim";
                        });
                        if (firstdim && firstdim.length <= 1) {
                            SHORT = true;
                        }
                        app.popup.open(".popup-weight", 0);
                        TYPEGRID = "dim";
                        var fi = formItem();
                        var grid = $("#grid-weight").dxDataGrid("instance");
                        grid.option("filterValue", ["Charge_Type", "=", "dim"]);
                        //grid.filter(["Charge_Type", "=", TYPEGRID]);
                        grid.option("editing.form.items", fi);

                        setTimeout(function () {
                            if (firstdim.length == 0) {
                                grid.addRow();
                            }
                            else if (firstdim.length == 1) {
                                var idx = grid.getRowIndexByKey(firstdim[0].ID);
                                grid.editRow(idx);
                            }
                        }, 0);
                    }
                });

                $("#Declared_Value").dxNumberBox({
                    format: "###,##0",
                    name: "Declared_Value",
                    value: self.poc.Declared_Value,
                });
                $("#COD_Amount").dxNumberBox({
                    format: "###,##0",
                    name: "COD_Amount",
                    value: self.poc.COD_Amount,
                });
                // $("#Freight_Charge").dxNumberBox({
                //     format: "###,##0",
                //     readOnly: true,

                // });
                // $("#Insurance_Surcharge").dxNumberBox({
                //     format: "###,##0",
                //     readOnly: true,

                // });
                // $("#VAS_Surcharge").dxNumberBox({
                //     format: "###,##0",
                //     readOnly: true,

                // });
                // $("#Other_Surcharge").dxNumberBox({
                //     format: "###,##0",
                //     readOnly: true,

                // });
                // $("#ESA_Surcharge").dxNumberBox({
                //     format: "###,##0",
                //     readOnly: true,

                // });
                // $("#Total_Charge").dxNumberBox({
                //     format: "###,##0",
                //     readOnly: true
                // });

                //debugger;
                //self.swiper = app.swiper.get('.swiper-container');
                function changeCheck() {
                    //debugger;
                    // var form = $("#formId").dxForm("instance");
                    // if (form) {

                    //     var ck = "hidden";
                    //     if ($("#iQui_Doi").dxCheckBox("instance").option("value")) {
                    //         ck = "showden";
                    //     }
                    //     if ($("#iDong_Go").dxCheckBox("instance").option("value")) {
                    //         ck = "showden";
                    //     }

                    //     form.itemOption("dimention", "cssClass", ck);
                    // }
                }
                function closeSHORT() {
                    //debugger;
                    if (SHORT) {
                        SHORT = false;
                        app.popup.close(".popup-weight", 0);
                    }
                };

                function validDRC(e) {
                    if (e.data.Dong_Go
                        || (e.data.Charge_Type && e.data.Charge_Type.includes("wood"))
                        || !e.data.Package_Weight
                        || e.data.Package_Weight <= 0
                    ) {
                        return e.value && e.value > 0;
                    }
                    return true;
                }
                function validWeight(e) {
                    debugger;
                    if (
                        (!e.data.Package_Length || e.data.Package_Length <= 0)
                        ||
                        (!e.data.Package_Width || e.data.Package_Width <= 0)
                        ||
                        (!e.data.Package_Height || e.data.Package_Height <= 0)
                    ) {
                        return e.value && e.value > 0;
                    }
                    return true;
                }

                $("#grid-weight").dxDataGrid({
                    dataSource: store,
                    repaintChangesOnly: true,
                    showBorders: true,
                    showRowLines: true,
                    paging: {
                        enabled: false
                    },
                    editing: {
                        mode: "popup",
                        useIcons: true,
                        allowUpdating: true,
                        allowDeleting: true,
                        allowAdding: true,
                        form: {
                            //colCount: 3,
                            colCountByScreen: {
                                xs: 3,
                                sm: 3,
                                lg: 3,
                                md: 3
                            },
                            elementAttr: {
                                id: "formId",
                            },
                            items: formItem(),
                            onContentReady: function () {
                                closeSHORT();
                            },
                            onInitialized: function () {
                                var bt = $('[aria-label="Thôi"]').dxButton("instance");
                                bt.on("click", closeSHORT);
                            }
                        }
                    },
                    onRowInserted: closeSHORT,
                    onRowUpdated: closeSHORT,
                    // onEditorPreparing: function (e) {
                    //     if (e.parentType == 'dataRow' && e.dataField == 'Dong_Go'                         ) {
                    //         e.editorOptions.onValueChanged = function (args) {
                    //             e.setValue(args.value);
                    //             if(args.value==true){
                    //                 if()
                    //             }
                    //         }
                    //     }
                    // },
                    onEditingStart: function (e) {
                        e.data.Modified_By = app.data.user.user_name;
                        e.data.Modified_Date = new Date();
                        e.data.Last_Source = "Mobile Pickup";
                        e.data.Last_Client_Name = cln;
                    },
                    onToolbarPreparing: function (e) {
                        var dataGrid = e.component;
                        var cln = "";
                        try {
                            cln = device.serial + ' ' + device.model + ' ' + device.manufacturer;
                        } catch (e) { }
                        e.toolbarOptions.items.unshift({
                            location: "before",
                            widget: "dxButton",
                            options: {
                                icon: 'back',
                                onClick: function (e) {
                                    app.popup.close();
                                }
                            }
                        });
                    },
                    onInitNewRow: function (e) {
                        e.data.Pickup_Order_Consignment_ID = pocID;
                        e.data.Created_By = app.data.user.user_name;
                        e.data.Created_Date = new Date();
                        e.data.Last_Source = "Mobile Pickup";
                        e.data.Last_Client_Name = cln;
                        e.data.Qui_Doi = false;
                        e.data.Dong_Go = false;
                        //debugger;
                        e.data.Charge_Type = TYPEGRID;
                    },
                    filterValue: ["Charge_Type", "=", TYPEGRID],
                    columns: [
                        {
                            dataField: "Charge_Type",
                            visible: false,
                            editorOptions: {
                                visible: false,
                            }
                        },
                        {
                            dataField: "Package_Weight",
                            caption: "Trọng lượng",
                            dataType: "number",
                            format: "###,##0.000",
                            editorOptions: {
                                format: "###,##0.000",
                                elementAttr: {
                                    id: "iPackage_Weight",
                                }
                            },
                            validationRules: [{
                                type: "custom",
                                validationCallback: validWeight,
                                message: "Trọng lượng không đúng!"
                            }],
                        },
                        {
                            dataField: "D_R_C",
                            caption: "D X R X C",
                            calculateCellValue: function (rowData) {
                                //debugger;
                                var str = "";
                                if (rowData.Package_Length > 0) {
                                    str += $.number(rowData.Package_Length, 2);
                                } else {
                                    str += " 0 ";
                                }
                                str += "x";
                                if (rowData.Package_Width > 0) {
                                    str += $.number(rowData.Package_Width, 2);
                                } else {
                                    str += " 0 ";
                                }
                                str += "x";
                                if (rowData.Package_Height > 0) {
                                    str += $.number(rowData.Package_Height, 2);
                                } else {
                                    str += " 0 ";
                                }
                                return str;
                            },
                        },
                        {
                            dataField: "Qui_Doi",
                            caption: "Quy đổi",
                            dataType: "boolean",
                            editorOptions: {
                                elementAttr: {
                                    id: "iQui_Doi",
                                },
                            },
                            visible: false,
                        },
                        {
                            dataField: "Dong_Go",
                            caption: "Đóng gỗ",
                            dataType: "boolean",
                            editorOptions: {
                                elementAttr: {
                                    id: "iDong_Go",
                                },
                                editCellTemplate: function (cellElement, cellInfo) {
                                    var bl = cellInfo.data.Charge_Type.includes("wood");
                                    $("<div />").dxSwitch({
                                        //width: 50,
                                        switchedOnText: "Có",
                                        switchedOffText: "Không",
                                        value: bl,
                                    }).appendTo(cellElement);
                                }
                            },
                            setCellValue: function (rowData, value) {
                                rowData.Dong_Go = value;
                                if (value == true) {
                                    if (rowData.Charge_Type) {
                                        if (!rowData.Charge_Type.includes("wood")) {
                                            rowData.Charge_Type += "wood";
                                        }
                                    } else {
                                        rowData.Charge_Type = "wood";
                                    }
                                } else {
                                    if (rowData.Charge_Type && rowData.Charge_Type.includes("wood")) {
                                        rowData.Charge_Type = rowData.Charge_Type.replace(/wood/g, "");
                                    }
                                }
                            },
                            visible: false,
                        },
                        {
                            dataField: "Package_Length",
                            caption: "Dài",
                            dataType: "number",
                            format: "###,##0",
                            editorOptions: {
                                format: "###,##0",
                                elementAttr: {
                                    id: "iPackage_Length",
                                }
                            },
                            visible: false,
                            validationRules: [{
                                type: "custom",
                                validationCallback: validDRC,
                                message: "Dài, rộng, cao không đúng!"
                            }],
                        },
                        {
                            dataField: "Package_Width",
                            caption: "Rộng",
                            dataType: "number",
                            format: "###,##0",
                            editorOptions: {
                                format: "###,##0",
                                elementAttr: {
                                    id: "iPackage_Width",
                                }
                            },
                            visible: false,
                            validationRules: [{
                                type: "custom",
                                validationCallback: validDRC,
                                message: "Dài, rộng, cao không đúng!"
                            }],
                        },
                        {
                            dataField: "Package_Height",
                            caption: "Cao",
                            dataType: "number",
                            format: "###,##0",
                            editorOptions: {
                                format: "###,##0",
                                elementAttr: {
                                    id: "iPackage_Height",
                                }
                            },
                            visible: false,
                            validationRules: [{
                                type: "custom",
                                validationCallback: validDRC,
                                message: "Dài, rộng, cao không đúng!"
                            }],
                        },
                    ]
                });
                var isEditCharge = false;
                $("#grid-summary").dxDataGrid({
                    dataSource: summaryStore,
                    repaintChangesOnly: true,
                    showBorders: true,
                    showRowLines: true,
                    paging: {
                        enabled: true,
                        pageSize: 5
                    },
                    editing: {
                        mode: "cell",
                        //refreshMode: "reshape",
                        useIcons: true,
                        allowUpdating: true,
                        allowDeleting: true,
                        allowAdding: true,
                    },
                    onEditingStart: function (e) {
                        e.data.Modified_By = app.data.user.user_name;
                        e.data.Modified_Date = new Date();
                        e.data.Last_Source = "Mobile Pickup";
                        e.data.Last_Client_Name = cln;
                        isEditCharge = true;
                        var grid = e.component;
                        grid.beginUpdate();
                        grid.columnOption("Surcharge_Code", "allowEditing", false);
                        grid.endUpdate();
                    },
                    onInitNewRow: function (e) {
                        e.data.Pickup_Order_Consignment_ID = pocID;
                        e.data.Created_By = app.data.user.user_name;
                        e.data.Created_Date = new Date();
                        e.data.Last_Source = "Mobile Pickup";
                        e.data.Last_Client_Name = cln;
                        e.data.Surcharge_Amount = 0;
                        e.data.SORT = new Date().getTime();
                        isEditCharge = false;
                        var grid = e.component;
                        grid.beginUpdate();
                        grid.columnOption("Surcharge_Code", "allowEditing", true);
                        grid.endUpdate();
                    },
                    onToolbarPreparing: function (e) {
                        var dataGrid = e.component;

                        e.toolbarOptions.items.unshift({
                            location: "before",
                            template: function () {
                                return $("<div/>")
                                    .addClass("informer")
                                    .append(
                                        // $("<h2 />")
                                        //     .addClass("count")
                                        //     .text(getGroupCount("CustomerStoreState")),
                                        $("<span />")
                                            .addClass("name")
                                            .text("Tiền cước đơn hàng")
                                    );
                            }
                        });
                    },                    
                    columns: [
                        {
                            dataField: "Surcharge_Code",
                            caption: "Nội dung",
                            lookup: {
                                dataSource: SURCHARGES,
                                valueExpr: "Surcharge_Code",
                                displayExpr: "Surcharge_TH_Name",
                            },                            
                            width: "60%",                            
                        },
                        {
                            dataField: "Surcharge_Amount_Collect",
                            caption: "Tiền",
                            dataType: "number",
                            format: "###,##0",
                            editorOptions: {
                                format: "###,##0",
                                elementAttr: {
                                    id: "iSurcharge_Amount_Collect",
                                }
                            },
                            width: "40%",
                            validationRules: [{
                                type: "required",
                                message: "Phải nhập số tiền"
                            }, {
                                type: "range",
                                min: 1000,
                                message: "Số tiền quá nhỏ"
                            }],
                            setCellValue: function (rowData, value) {
                                rowData.Surcharge_Amount_Collect = value;
                                rowData.Surcharge_Amount = value;
                            },
                        },
                        {
                            calculateCellValue:function(rowData){
                                if(rowData.Surcharge_Code=="FC"){
                                    return "000";
                                }
                                return rowData.Surcharge_Code;
                                    
                            },
                            sortOrder: "asc",
                            visible: false,
                            editorOptions: {
                                visible: false,
                            }
                        }
                    ],
                    summary: {
                        recalculateWhileEditing: true,
                        totalItems: [{
                            column: "Surcharge_Code",
                            summaryType: "count",
                            valueFormat: "###,##0",
                            displayFormat: "Tổng ({0})",
                        }, {
                            column: "Surcharge_Amount_Collect",
                            summaryType: "sum",
                            valueFormat: "###,##0",
                            displayFormat: "{0}",
                        }]
                    }
                });

            },
            pageBeforeIn: function (e, page) {

            },
            pageAfterIn: function (e, page) {
                console.log('pageAfterIn', page);
                var self = this;
                self.swiper = app.swiper.get('.swiper-container');

                if (self.poc.FINISH && self.poc.FINISH > 0) {
                    $$(".save-command").hide();
                } else {
                    $$(".save-command").show();
                }
                if (!self.poc.Consignment_No || self.poc.Consignment_No.length == 0) {
                    self.poc.Consignment_No = self.init_Consignment_No();
                    $$("#Consignment_No").val(self.poc.Consignment_No);
                }
            },
            pageBeforeOut: function (e, page) {
                console.log('pageBeforeOut', page);
                if (app.data.editing) {
                    var rs = confirm("Dữ liệu chưa được lưu. Vẫn thoát?");
                    debugger;
                    if (rs) {
                        app.data.editing = false;
                    } else {
                        e.cancelled = true;
                    }
                }
            },
            pageAfterOut: function (e, page) {
                console.log('pageAfterOut', page);
            },
            pageBeforeRemove: function (e, page) {
                console.log('pageBeforeRemove', page);
            },
        }
    }
</script>