<template>
    <div class="page">
        <div class="navbar">
            <div class="navbar-inner sliding">
                <div class="left">
                    <a href="#" class="link back">
                        <i class="icon icon-back"></i>
                        <span class="ios-only">Back</span>
                    </a>
                </div>
                <div class="title">{{$root.appName}}</div>
            </div>
        </div>
        <div class="page-content">
            <div class="card">
                <div class="card-header">
                    Thông tin người gửi
                    <span class="right">
                        <a class="link icon-only edit" href="#">
                            <i class="icon f7-icons ios-only">edit</i>
                            <i class="icon material-icons md-only">edit</i>
                        </a>
                    </span>
                </div>
                <div class="card-content card-content-padding">
                    <div class="list media-list">
                        {{#with po}}
                        <ul>
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title-row">
                                            <div class="item-title">
                                                Người gửi: <span class="Sender_Name">{{Sender_Name}}</span>
                                            </div>
                                            <div class="item-after"></div>
                                        </div>
                                        <div class="item-subtitle">
                                            SĐT: <span class="Phone_No">{{Sender_Phone_No}}</span>
                                            <span
                                                class="Contact_Person">{{#js_if "this.Contact_Person && this.Contact_Person.length>0"}}
                                                - {{Contact_Person}}{{/js_if}}</span>
                                        </div>
                                        <div class="item-text">
                                            Đ/c: <span class="Address">{{Address}}</span>
                                        </div>
                                    </div>
                                </div>

                            </li>
                        </ul>
                        {{/with}}
                    </div>
                </div>
                <!-- <div class="card-footer">Card Footer</div> -->
            </div>
            <div class="block inset command-panel">
                <p class="row">
                    <button class="col button button-large button-raised bill-scan4">
                        <i class="icon f7-icons ios-only" style="font-size:x-large">qrcode</i>
                        <i class="icon material-icons md-only" style="font-size:x-large">settings_overscan</i>
                        <span>Vận đơn 4 liên</span>
                    </button>
                </p>
                <p class="row">

                </p>
                <p class="row">
                    <a href="#" class="col button button-large button-raised button-fill bill-create">
                        <i class="icon f7-icons ios-only" style="font-size:x-large">compose_fill</i>
                        <i class="icon material-icons md-only" style="font-size:x-large">fiber_new</i>
                        <span>Hệ thống</span>
                    </a>
                </p>
            </div>
            <div class="data-table data-table-init card scan4-panel" style="display:none;">
                <!-- Card header -->
                <div class="card-header">
                    <!-- Default table header -->
                    <div class="data-table-header">
                        <!-- Default table title -->
                        <div class="data-table-title">Liên kết VĐ 4 Liên</div>
                        <!-- Default table actions -->
                        <div class="data-table-actions">
                            <a class="link icon-only scan-next">
                                <i class="icon f7-icons ios-only">qrcode</i>
                                <i class="icon material-icons md-only">settings_overscan</i>
                            </a>
                            <a class="link icon-only scan-switch" data-type="2">
                                <i class="icon f7-icons ios-only">reload</i>
                                <i class="icon material-icons md-only">swap_vert</i>
                            </a>
                        </div>
                    </div>
                    <!-- Selected table header -->
                    <div class="data-table-header-selected">
                        <!-- Selected table title -->
                        <div class="data-table-title-selected"><span class="data-table-selected-count"></span> vđ</div>
                        <!-- Selected table actions -->
                        <div class="data-table-actions">
                            <a class="link icon-only delete">
                                <i class="icon f7-icons ios-only">trash</i>
                                <i class="icon material-icons md-only">delete</i>
                            </a>
                            <a class="link icon-only">
                                <i class="icon f7-icons ios-only">more_vertical_round</i>
                                <i class="icon material-icons md-only">more_vert</i>
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-content">
                    <table id="tbody">
                        <thead>
                            <tr>
                                <th class="checkbox-cell">
                                    <label class="checkbox">
                                        <input type="checkbox" class="all-selected">
                                        <i class="icon-checkbox"></i>
                                    </label>
                                </th>
                                <th class="label-cell">Vận đơn 4 liên đã quét</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- <tr>
                                <td class="checkbox-cell">
                                    <label class="checkbox">
                                        <input type="checkbox">
                                        <i class="icon-checkbox"></i>
                                    </label>
                                </td>
                                <td class="label-cell"></td>                                
                            </tr> -->
                        </tbody>
                    </table>
                    <div class="data-table-footer show-footer" style="display:none;">
                        <div class="segmented" style="padding-right: 15px;">
                            <a class="button button-active finish-scan4">
                                <i class="icon f7-icons ios-only">check</i>
                                <i class="icon material-icons md-only">check</i>
                                Xác nhận
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card create-panel" style="display:none;">
                <div class="card-header">
                    Danh sách đơn đã tạo
                    <span class="right">
                        <a class="link icon-only scan-switch" data-type="1">
                            <i class="icon f7-icons ios-only">reload</i>
                            <i class="icon material-icons md-only">swap_vert</i>
                        </a>
                    </span>
                </div>
                <!-- <div class="card-footer">
                    <a class="button" href="/poc/0/">
                        <i class="icon f7-icons ios-only">add</i>
                        <i class="icon material-icons md-only">add</i>
                        Thêm
                    </a>
                    <a class="button finish-create" href="#">
                        <i class="icon f7-icons ios-only">check</i>
                        <i class="icon material-icons md-only">check</i>
                        Xác nhận
                    </a>
                </div>
                <div class="card-header">
                    Tổng tiền cần thu <span class="right total-money format-number">0</span>
                </div> -->
                <!-- <div class="card-content card-content-padding">
                    <div class="list virtual-list media-list chevron-center" id="bill-list">
                    </div>
                </div> -->
                <div id="bill-list"></div>
            </div>

        </div>
    </div>
</template>
<style>
    p {
        margin: 10px 0;
    }
</style>
<script type="text/javascript">

    var store = [];

    var MULTISCAN = false;
    var getKeyCode = function (str) {
        return str.charCodeAt(str.length);
    }
    function findAndPushOFDS(vl) {
        console.log(vl);
        var test = vl.replace(/[^0-9a-zA-Z_\-]/g, '');
        if (test != vl) {
            app.toast.create({
                text: "Lỗi: SVĐ sai định dạng",
                closeTimeout: 2000,
            }).open();
            return;
        }
        //debugger;
        var fou = false;
        for (var i = 0; i < store.length; i++) {
            if (store[i] == vl) {
                //navigator.notification.beep(2);
                navigator.vibrate([200, 200]);
                return;
            }
        }
        navigator.notification.beep(1);
        navigator.vibrate(200);
        store.push(vl);
        $$("#tbody").find('tbody').append(
            $$('<tr>').append($$('<td class="checkbox-cell">' +
                '   <label class="checkbox">' +
                '       <input class="vd-selected" type="checkbox" data-value="' + vl + '">' +
                '       <i class="icon-checkbox"></i>' +
                '   </label>' +
                '</td>'),
                $$('<td class="label-cell">' + vl + '</td>'))
        );
        //debugger;
        if (store.length > 0) {
            $$(".show-footer").show();
        } else {
            $$(".show-footer").hide();
        }

    }
    function scanBarcode() {
        cordova.plugins.barcodeScanner.scan(
            function (result) {
                //console.log(result);
                if (result.cancelled) {
                    MULTISCAN = false;
                    return;
                }
                var vl = result.text;
                if (vl.length > 3) {
                    findAndPushOFDS(vl);
                }
                if (MULTISCAN) {
                    setTimeout(function () {
                        scanBarcode();
                    }, 100);
                }
            },
            function (error) {
                // if (MULTISCAN) {
                //     setTimeout(function () {
                //         scanBarcode();
                //     }, 2000);
                // }
            },
            {
                preferFrontCamera: false, // iOS and Android
                showFlipCameraButton: true, // iOS and Android
                showTorchButton: true, // iOS and Android
                torchOn: false, // Android, launch with the torch switched on (if available)
                saveHistory: true, // Android, save scan history (default false)
                prompt: "Đưa mã vạch hiện vào khu vực quét", // Android
                resultDisplayDuration: 500, // Android, display scanned text for X ms. 0 suppresses it entirely, default 1500
                formats: "QR_CODE,CODE_128", // default: all but PDF_417 and RSS_EXPANDED
                orientation: "portrait", // Android only (portrait|landscape), default unset so it rotates with the device
                disableAnimations: true, // iOS
                disableSuccessBeep: true // iOS and Android
            }
        );
    }
    return {
        // Component Data
        data: function () {
            // Must return an object
            return {
                po: {},
                vl: null,
                store: null,
            }
        },
        // Component Methods
        methods: {
            setTYPE: function (type) {
                if (type == 0) {
                    $$(".command-panel").show();
                    $$(".create-panel").hide();
                    $$(".scan4-panel").hide();
                } else if (type == 1) {
                    $$(".command-panel").hide();
                    $$(".create-panel").hide();
                    $$(".scan4-panel").show();
                } else {
                    $$(".command-panel").hide();
                    $$(".create-panel").show();
                    $$(".scan4-panel").hide();
                }
            },
        },
        // Lifecycle Hooks
        beforeCreate: function () {
            console.log('componentBeforeCreate', this)
        },
        created: function () {
            console.log('componentCreated', this)
        },
        beforeMount: function () {
            console.log('componentBeforeMount', this)
        },
        mounted: function () {
            console.log('componentMounted', this);
        },
        updated: function () {
            console.log('componentUpdated', this);
        },
        beforeDestroy: function () {
            console.log('componentBeforeDestroy', this);
        },
        destroyed: function () {
            console.log('componentDestroyed', this);
        },
        // Page Events
        on: {
            pageMounted: function (e, page) {
                console.log('pageMounted', page);
                //debugger;

            },
            pageInit: function (e, page) {
                console.log('pageInit', page);
                var self = this;
                var poID = page.route.params.poID;
                console.log(poID);
                var store = app.methods.initCacher("Pickup_Order_Consignment", [
                    "Pickup_Order_ID", "=", poID
                ]);
                self.store = store;
                self.po = app.data.items.find(function (x) {
                    return x.ID == poID;
                });
                self.po.TYPE = self.po.TYPE || 0;
                if (self.po.TYPE == 0) {
                    selectLSM("Pickup_Order", self.po, "ID", function (x) {
                        if (x && x.length > 0 && x[0].TYPE && x[0].TYPE > 0) {
                            self.po.TYPE = x[0].TYPE;
                        } else {
                            replaceLSM("Pickup_Order", self.po, "ID");
                        }

                    });
                }

                app.data.lastChoice = self.po;

                $$(".Sender_Name").text(self.po.Sender_Name);
                $$(".Phone_No").text(self.po.Phone_No);
                $$(".Address").text(self.po.Address);
                $$(".Contact_Person").text(self.po.Contact_Person);
                $$(".edit").attr("href", "/po/" + poID + "/edit/");
                $$('.bill-create').off('click').on('click', function () {
                    self.po.TYPE = 2;
                    replaceLSM("Pickup_Order", self.po, "ID");
                    $$(".command-panel").hide();
                    $$(".create-panel").show();
                    var pend = store.store._array.filter(function (x) {
                        var t = x.FINISH && x.FINISH > 0;
                        return !t;
                    });
                    var tmp = { ID: 0 };
                    if (pend.length > 0) {
                        var tmp = pend[0];

                    }
                    //app.data.lastChoice = self.po;
                    mainView.router.navigate("/poc/" + tmp.ID + "/");
                });
                //$$(".bill-create").attr("href", "/po/" + poID + "/addbill/");
                $$('.bill-scan4').off('click').on('click', function () {
                    self.po.TYPE = 1;
                    replaceLSM("Pickup_Order", self.po, "ID");
                    $$(".command-panel").hide();
                    $$(".scan4-panel").show();
                    MULTISCAN = true;
                    scanBarcode();
                });
                $$('.scan-next').off('click').on('click', function () {
                    MULTISCAN = true;
                    scanBarcode();
                });
                $$('.delete').on('click', function () {
                    var l = $$(".vd-selected:checked");
                    $.each(l, function () {
                        var vl = $$(this).data("value");
                        store.splice(store.indexOf(vl), 1);
                    });

                    $('#tbody tr').has('.vd-selected:checked').remove();
                    $('.scan4-panel').removeClass("data-table-has-checked");
                    if (store.length > 0) {
                        $$(".show-footer").show();
                    } else {
                        $$(".show-footer").hide();
                    }

                });
                $$(".finish-scan4").on('click', function () {
                    app.toast.create({
                        text: JSON.stringify(store),
                        closeTimeout: 2000,
                    }).open();
                    app.router.back();
                });

               

                $("#bill-list").dxDataGrid({
                    dataSource: store,
                    repaintChangesOnly: true,
                    showBorders: true,
                    showRowLines: true,
                    paging: {
                        enabled: false,
                    },
                    editing: {
                        //mode: "cell",
                        //refreshMode: "reshape",
                        useIcons: true,
                        //allowUpdating: true,
                        allowDeleting: true,
                        //allowAdding: true,
                    },
                    onToolbarPreparing: function (e) {
                        var dataGrid = e.component;

                        e.toolbarOptions.items.unshift(
                            {
                                location: "before",
                                widget: "dxButton",
                                options: {
                                    text: "Hoàn thành",
                                    //width: 136,
                                    elementAttr: {
                                        id: "finishID",
                                        class: "text-color-deeporange"
                                    },
                                    icon: "dx-icon dx-icon-check text-color-deeporange",
                                    onClick: function (e) {
                                        var c = 0;
                                        var total = 0;
                                        for (var i = 0; i < store.store._array.length; i++) {
                                            c++;
                                            total += store.store._array[i].Total_Charge || 0;
                                        }
                                        app.dialog.confirm('Nhận thành công với ' + c + ' vđ. Tổng số tiền <span style="color:orange"><strong>' + $.number(total) + '</strong></span>?', function () {
                                            app.methods.pickup(poID, 3, 0, '');
                                        });
                                    }
                                }
                            },
                            {
                                location: "after",
                                widget: "dxButton",
                                options: {
                                    text: "Mới",
                                    //width: 136,
                                    icon: "dx-icon dx-icon-add text-color-deeporange",
                                    elementAttr: {
                                        id: "addID",
                                        class: "text-color-deeporange"
                                    },
                                    onClick: function (e) {
                                        mainView.router.navigate("/poc/0/");
                                    }
                                }
                            },
                        );
                    },
                    onRowClick: function(e){
                        mainView.router.navigate("/poc/"+ e.key +"/");
                    },
                    columns: [
                        {
                            dataField: "Consignment_No",
                            caption: "Số vận đơn",
                            width: "60%",
                        },
                        {
                            dataField: "Total_Charge",
                            caption: "Số Tiền",
                            dataType: "number",
                            format: "###,##0",
                            width: "40%",
                        },
                    ],                    
                    summary: {
                        recalculateWhileEditing: true,
                        totalItems: [{
                            column: "Consignment_No",
                            summaryType: "count",
                            valueFormat: "###,##0",
                            displayFormat: "Tổng ({0})",
                        }, {
                            column: "Total_Charge",
                            summaryType: "sum",
                            valueFormat: "###,##0",
                            displayFormat: "{0}",
                        }]
                    }
                });
            },
            pageBeforeIn: function (e, page) {
                console.log('pageBeforeIn', page);
            },
            pageAfterIn: function (e, page) {
                var self = this;
                console.log('pageAfterIn', page);
                $$(".scan-switch").on("click", function () {
                    var type = $$(this).data("type") || 0;
                    self.po.TYPE = type;
                    replaceLSM("Pickup_Order", self.po, "ID");
                    self.setTYPE(self.po.TYPE);
                });
                self.setTYPE(self.po.TYPE);
            },
            pageBeforeOut: function (e, page) {
                console.log('pageBeforeOut', page);
            },
            pageAfterOut: function (e, page) {
                console.log('pageAfterOut', page);
            },
            pageBeforeRemove: function (e, page) {
                console.log('pageBeforeRemove', page);
            },
        }
    }
</script>